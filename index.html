<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Canvas Image Tabs with Watermark</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }
        #tabs {
            display: flex;
            justify-content: center;
            background-color: #333;
            width: 100%;
            position: fixed;
            top: 0;
            z-index: 100;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            color: white;
            background-color: #555;
            margin: 0 5px;
            font-size: 16px;
        }
        .tab.active {
            background-color: #ff9800;
        }
        canvas {
            border: 1px solid #000000;
            cursor: grab;
            flex-grow: 1;
            margin-top: 40px;
        }
        canvas:active {
            cursor: grabbing;
        }
        #zoom-level {
            position: fixed;
            right: 10px;
            bottom: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        #tip {
            position: fixed;
            left: 10px;
            bottom: 10px;
            background-color: rgba(255, 165, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 100;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #ff9800;
            display: none;
        }
        @keyframes rotate {
            100% { transform: rotate(360deg); }
        }
        #loading-download {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #ff9800;
            display: none;
            z-index: 200; /* 使其显示在最前面 */
        }

        .loading-icon {
            border: 6px solid rgba(0, 0, 0, 0.1);
            border-top: 6px solid #ff9800;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: rotate 1s linear infinite;
            margin-bottom: 10px;
        }
        .loading-icon {
            border: 6px solid rgba(0, 0, 0, 0.1);
            border-top: 6px solid #ff9800;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: rotate 1s linear infinite;
            margin-bottom: 10px;
        }
        #download-btn {
            position: fixed;
            bottom: 20px;
            padding: 10px 20px;
            background-color: #ff9800;
            color: white;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            outline: none;
            z-index: 100;
        }
        #download-btn:hover {
            background-color: #e68900;
        }
    </style>
</head>
<body>
    <div id="tabs">
        <div class="tab">康熙二十六年</div>
        <div class="tab">光绪二十八年</div>
        <div class="tab">民国二十年</div>
    </div>
    <canvas id="myCanvas"></canvas>
    <div id="zoom-level">缩放比例: 100%</div>
    <div id="tip">滚轮/双指缩放，左键/单指拖动</div>
    <div id="loading">
        <div class="loading-icon"></div>
        <div>图片加载中...</div>
    </div>
    <button id="download-btn">下载图片</button>
    <!-- 其他代码保持不变 -->
    <div id="loading-download">
        <div class="loading-icon"></div>
        <div>图片生成中...</div>
    </div>

    <script>
        window.onload = function () {
            var canvas = document.getElementById('myCanvas');
            var ctx = canvas.getContext('2d');

            var tabs = document.getElementsByClassName('tab');
            var loadingDiv = document.getElementById('loading'); // Loading animation

            var images = [
                new Image(),
                new Image(),
                new Image()
            ];

            var imageSources = [
                'https://raw.githubusercontent.com/jarain/jarain.github.io/refs/heads/main/kx.jpg',
                'https://raw.githubusercontent.com/jarain/jarain.github.io/refs/heads/main/gx.jpg',
                'https://raw.githubusercontent.com/jarain/jarain.github.io/refs/heads/main/mg.jpg'
            ];

            var currentImageIndex = 0;
            var scale = 0.7;
            var minScale = 0.1;
            var maxScale = 5;
            var canvasCenterX, canvasCenterY;
            var isDragging = false;
            var dragStartX, dragStartY;
            var initialPinchDistance = null;
            var savedStates = [];

            var zoomLevelDisplay = document.getElementById('zoom-level');
            var downloadLoading = document.getElementById('loading-download'); // 下载加载动画

            images.forEach((img, index) => {
                img.crossOrigin = "anonymous"; // 加上跨域处理
                img.src = imageSources[index];
                img.onload = function () {
                    if (index === 0) {
                        initCanvas();
                    }
                    loadingDiv.style.display = 'none'; // 图片加载完成，隐藏加载动画
                };
            });

            loadingDiv.style.display = 'block'; // 显示加载动画

            function initCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight - 40; // 去掉顶部标签的高度

                canvasCenterX = canvas.width / 2;
                canvasCenterY = canvas.height / 2;

                for (let i = 0; i < tabs.length; i++) {
                    savedStates[i] = {
                        scale: 0.1,
                        centerX: canvas.width / 2,
                        centerY: canvas.height / 2
                    };
                }

                drawImage();
            }

            function drawImage() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                ctx.save();
                ctx.translate(canvasCenterX, canvasCenterY);
                ctx.scale(scale, scale);
                var img = images[currentImageIndex];
                ctx.translate(-img.width / 2, -img.height / 2);
                ctx.drawImage(img, 0, 0);
                ctx.restore();

                zoomLevelDisplay.innerHTML = '缩放比例: ' + Math.round(scale * 100) + '%';
            }

            function switchImage(index) {
                savedStates[currentImageIndex] = {
                    scale: scale,
                    centerX: canvasCenterX,
                    centerY: canvasCenterY
                };

                currentImageIndex = index;

                scale = savedStates[currentImageIndex].scale;
                canvasCenterX = savedStates[currentImageIndex].centerX;
                canvasCenterY = savedStates[currentImageIndex].centerY;

                drawImage();
            }

            for (let i = 0; i < tabs.length; i++) {
                tabs[i].addEventListener('click', function () {
                    for (let j = 0; j < tabs.length; j++) {
                        tabs[j].classList.remove('active');
                    }
                    this.classList.add('active');
                    switchImage(i);
                });
            }

            tabs[0].classList.add('active');

            // 下载按钮的跨域问题
            document.getElementById('download-btn').addEventListener('click', function () {
                downloadLoading.style.display = 'block';
                var img = images[currentImageIndex];

                var tempCanvas = document.createElement('canvas');
                var tempCtx = tempCanvas.getContext('2d');

                tempCanvas.width = img.width;
                tempCanvas.height = img.height;

                tempCtx.drawImage(img, 0, 0);

                // 添加水印
                var watermarkText = "热爱正当时";
                tempCtx.font = "bold " + (img.width * 0.12) + "px Arial";
                tempCtx.textAlign = 'center';
                tempCtx.textBaseline = 'middle';
                tempCtx.globalAlpha = 0.15;
                tempCtx.fillStyle = "white";
                tempCtx.fillText(watermarkText, tempCanvas.width / 2, tempCanvas.height / 2);

                // 添加下载日期
                var Dtxt="下载日期："
                tempCtx.globalAlpha = 1;
                tempCtx.font = "bold " + (img.width * 0.02) + "px Arial";
                tempCtx.textAlign = 'right';
                tempCtx.textBaseline = 'bottom';
                tempCtx.fillText(Dtxt+new Date().toLocaleDateString(), tempCanvas.width - 150, tempCanvas.height - 50);

                // 下载图像
                var link = document.createElement('a');
                link.href = tempCanvas.toDataURL('image/jpeg', 0.7); // 改为 JPEG 格式，质量 0.7
                link.download = 'map_ap.jpg';
                link.click();
                downloadLoading.style.display = 'none';

            });

            window.addEventListener('resize', initCanvas);

            canvas.addEventListener('wheel', function (event) {
                var delta = Math.sign(event.deltaY);
                var zoomFactor = 1.1;

                if (delta > 0) {
                    scale /= zoomFactor;
                } else {
                    scale *= zoomFactor;
                }

                scale = Math.min(maxScale, Math.max(minScale, scale));

                drawImage();
            });

            canvas.addEventListener('mousedown', function (event) {
                isDragging = true;
                dragStartX = event.clientX;
                dragStartY = event.clientY;
                canvas.style.cursor = 'grabbing';
            });

            canvas.addEventListener('mousemove', function (event) {
                if (isDragging) {
                    var dx = event.clientX - dragStartX;
                    var dy = event.clientY - dragStartY;

                    canvasCenterX += dx;
                    canvasCenterY += dy;

                    dragStartX = event.clientX;
                    dragStartY = event.clientY;

                    drawImage();
                }
            });

            canvas.addEventListener('mouseup', function () {
                isDragging = false;
                canvas.style.cursor = 'grab';
            });

            canvas.addEventListener('touchstart', function (event) {
                if (event.touches.length === 2) {
                    initialPinchDistance = getPinchDistance(event);
                }
            });

            canvas.addEventListener('touchmove', function (event) {
                if (event.touches.length === 2) {
                    var currentPinchDistance = getPinchDistance(event);
                    if (initialPinchDistance !== null) {
                        var pinchScale = currentPinchDistance / initialPinchDistance;
                        scale *= pinchScale;
                        scale = Math.min(maxScale, Math.max(minScale, scale));
                        initialPinchDistance = currentPinchDistance;
                        drawImage();
                    }
                }
            });

            canvas.addEventListener('touchend', function () {
                initialPinchDistance = null;
            });

            function getPinchDistance(event) {
                var dx = event.touches[0].clientX - event.touches[1].clientX;
                var dy = event.touches[0].clientY - event.touches[1].clientY;
                return Math.sqrt(dx * dx + dy * dy);
            }
        };
    </script>
</body>
</html>
