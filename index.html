<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>AnpingMaps</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }
        #tabs {
            display: flex;
            justify-content: center;
            background-color: #333;
            width: 100%;
            position: fixed;
            top: 0;
            z-index: 100;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            color: white;
            background-color: #555;
            margin: 0 5px;
            font-size: 16px;
        }
        .tab.active {
            background-color: #ff9800;
        }
        canvas {
            border: 1px solid #000000;
            cursor: grab;
            flex-grow: 1;
            margin-top: 40px; /* 为了不让标签遮住Canvas内容 */
        }
        canvas:active {
            cursor: grabbing;
        }
        #zoom-level {
            position: fixed;
            right: 10px;
            bottom: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        #tip {
            position: fixed;
            left: 10px;
            bottom: 10px;
            background-color: rgba(255, 165, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 100;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #ff9800;
            display: none; /* Initially hidden */
        }
        @keyframes rotate {
            100% { transform: rotate(360deg); }
        }
        .loading-icon {
            border: 6px solid rgba(0, 0, 0, 0.1);
            border-top: 6px solid #ff9800;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: rotate 1s linear infinite;
            margin-bottom: 10px;
        }
        #download-btn {
            position: fixed;
            bottom: 20px;
            padding: 10px 20px;
            background-color: #ff9800;
            color: white;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            outline: none;
            z-index: 100;
        }
        #download-btn:hover {
            background-color: #e68900;
        }
    </style>
    <script>
        window.onload = function () {
            var canvas = document.getElementById('myCanvas');
            var ctx = canvas.getContext('2d');

            var tabs = document.getElementsByClassName('tab');
            var loadingDiv = document.getElementById('loading'); // Loading animation

            var images = [
                new Image(),
                new Image(),
                new Image()
            ];

            var imageSources = [
                'kx.jpg', // 替换为你的第一张图片路径
                'gx.jpg', // 替换为你的第二张图片路径
                'mg.jpg'  // 替换为你的第三张图片路径
            ];

            var currentImageIndex = 0;
            var scale = 0.1;
            var minScale = 0.1;
            var maxScale = 5;
            var canvasCenterX, canvasCenterY;
            var isDragging = false;
            var dragStartX, dragStartY;
            var initialPinchDistance = null;
            var savedStates = [];

            var zoomLevelDisplay = document.getElementById('zoom-level');

            // 初始化图片加载
            images.forEach((img, index) => {
                img.src = imageSources[index];
                img.onload = function () {
                    if (index === 0) {
                        initCanvas();
                    }
                    loadingDiv.style.display = 'none';
                };
            });

            loadingDiv.style.display = 'block'; // 显示加载动画

            function initCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight - 40; // 去掉顶部标签的高度

                canvasCenterX = canvas.width / 2;
                canvasCenterY = canvas.height / 2;

                for (let i = 0; i < tabs.length; i++) {
                    savedStates[i] = {
                        scale: 0.1,
                        centerX: canvas.width / 2,
                        centerY: canvas.height / 2
                    };
                }

                drawImage();
            }

            function drawImage() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                ctx.save();
                ctx.translate(canvasCenterX, canvasCenterY);
                ctx.scale(scale, scale);
                var img = images[currentImageIndex];
                ctx.translate(-img.width / 2, -img.height / 2);
                ctx.drawImage(img, 0, 0);
                ctx.restore();

                zoomLevelDisplay.innerHTML = '缩放比例: ' + Math.round(scale * 100) + '%';
            }

            function switchImage(index) {
                savedStates[currentImageIndex] = {
                    scale: scale,
                    centerX: canvasCenterX,
                    centerY: canvasCenterY
                };

                loadingDiv.style.display = 'block';

                currentImageIndex = index;

                scale = savedStates[currentImageIndex].scale;
                canvasCenterX = savedStates[currentImageIndex].centerX;
                canvasCenterY = savedStates[currentImageIndex].centerY;

                images[currentImageIndex].onload = function () {
                    loadingDiv.style.display = 'none';
                    drawImage();
                };

                drawImage();
            }

            for (let i = 0; i < tabs.length; i++) {
                tabs[i].addEventListener('click', function () {
                    for (let j = 0; j < tabs.length; j++) {
                        tabs[j].classList.remove('active');
                    }
                    this.classList.add('active');
                    switchImage(i);
                });
            }

            tabs[0].classList.add('active');

            canvas.addEventListener('wheel', function (e) {
                e.preventDefault();

                var rect = canvas.getBoundingClientRect();
                var mouseX = e.clientX - rect.left;
                var mouseY = e.clientY - rect.top;

                var imgX = (mouseX - canvasCenterX) / scale;
                var imgY = (mouseY - canvasCenterY) / scale;

                var scaleFactor = 1.1;
                if (e.deltaY < 0 && scale < maxScale) {
                    scale *= scaleFactor;
                } else if (e.deltaY > 0 && scale > minScale) {
                    scale /= scaleFactor;
                }

                canvasCenterX = mouseX - imgX * scale;
                canvasCenterY = mouseY - imgY * scale;

                drawImage();
            });

            canvas.addEventListener('mousedown', function (e) {
                if (e.button === 0) {
                    isDragging = true;
                    dragStartX = e.clientX;
                    dragStartY = e.clientY;
                    canvas.style.cursor = 'grabbing';
                }
            });

            canvas.addEventListener('mousemove', function (e) {
                if (isDragging) {
                    var dx = e.clientX - dragStartX;
                    var dy = e.clientY - dragStartY;
                    canvasCenterX += dx;
                    canvasCenterY += dy;
                    dragStartX = e.clientX;
                    dragStartY = e.clientY;
                    drawImage();
                }
            });

            canvas.addEventListener('mouseup', function () {
                isDragging = false;
                canvas.style.cursor = 'grab';
            });

            canvas.addEventListener('mouseleave', function () {
                isDragging = false;
                canvas.style.cursor = 'grab';
            });

            canvas.addEventListener('touchstart', function (e) {
                if (e.touches.length === 2) {
                    initialPinchDistance = getPinchDistance(e.touches);
                } else if (e.touches.length === 1) {
                    isDragging = true;
                    dragStartX = e.touches[0].clientX;
                    dragStartY = e.touches[0].clientY;
                }
            });

            canvas.addEventListener('touchmove', function (e) {
                e.preventDefault();
                if (e.touches.length === 2 && initialPinchDistance) {
                    var currentPinchDistance = getPinchDistance(e.touches);
                    var pinchRatio = currentPinchDistance / initialPinchDistance;
                    if (pinchRatio > 1 && scale < maxScale) {
                        scale *= pinchRatio;
                    } else if (pinchRatio < 1 && scale > minScale) {
                        scale /= pinchRatio;
                    }
                    initialPinchDistance = currentPinchDistance;
                    drawImage();
                } else if (e.touches.length === 1 && isDragging) {
                    var dx = e.touches[0].clientX - dragStartX;
                    var dy = e.touches[0].clientY - dragStartY;
                    canvasCenterX += dx;
                    canvasCenterY += dy;
                    dragStartX = e.touches[0].clientX;
                    dragStartY = e.touches[0].clientY;
                    drawImage();
                }
            });

            canvas.addEventListener('touchend', function () {
                isDragging = false;
                initialPinchDistance = null;
            });

            function getPinchDistance(touches) {
                var dx = touches[0].clientX - touches[1].clientX;
                var dy = touches[0].clientY - touches[1].clientY;
                return Math.sqrt(dx * dx + dy * dy);
            }

            // 禁用右键菜单
            canvas.addEventListener('contextmenu', function (e) {
                e.preventDefault();
            });

            // 下载图片并添加水印
            document.getElementById('download-btn').addEventListener('click', function () {
                // 创建一个临时canvas
                var tempCanvas = document.createElement('canvas');
                var tempCtx = tempCanvas.getContext('2d');
                var img = images[currentImageIndex];

                tempCanvas.width = img.width;
                tempCanvas.height = img.height;

                // 绘制原始图片
                tempCtx.drawImage(img, 0, 0);

                // 添加水印
                tempCtx.font = 'bold 48px Arial';
                tempCtx.textAlign = 'center';
                tempCtx.textBaseline = 'middle';
                tempCtx.globalAlpha = 0.5; // 设置透明度
                var watermarkText = '热爱正当时';
                tempCtx.fillStyle = '#ff9800';
                tempCtx.fillText(watermarkText, tempCanvas.width / 2, tempCanvas.height / 2);

                // 添加下载日期
                var dateText = new Date().toLocaleDateString();
                tempCtx.font = '24px Arial';
                tempCtx.globalAlpha = 1; // 重置透明度
                tempCtx.fillText(dateText, tempCanvas.width - 100, tempCanvas.height - 30);

                // 创建下载链接
                var link = document.createElement('a');
                link.href = tempCanvas.toDataURL('image/png');
                link.download = 'image_with_watermark.png';
                link.click();
            });
        };
    </script>
</head>
<body>
    <div id="tabs">
        <div class="tab">康熙二十六年</div>
        <div class="tab">光绪二十八年</div>
        <div class="tab">民国二十年</div>
    </div>
    <canvas id="myCanvas"></canvas>
    <div id="zoom-level">缩放比例: 100%</div>
    <div id="tip">滚轮/双指缩放，左键/单指拖动</div>
    <div id="loading">
        <div class="loading-icon"></div>
        <div>图片加载中...</div>
    </div>
    <button id="download-btn">下载图片</button>
</body>
</html>
